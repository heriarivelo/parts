<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <!-- En-tête -->
  <div class="sm:flex sm:items-center mb-8">
    <div class="sm:flex-auto">
      <h1 class="text-2xl font-bold leading-tight text-gray-900">Commandes</h1>
      <p class="mt-2 text-sm text-gray-600">Liste des commandes en cours</p>
    </div>

    <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
      <a routerLink="/manager/order"
        class="block rounded-md bg-primary px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-red-500">
        Nouvelle commande
      </a>
    </div>
  </div>

  <!-- Tabs -->
  <div class="flex border-b border-gray-200 mb-6">
    <button
      (click)="switchTab('STANDARD')"
      [ngClass]="{
        'border-b-2 border-blue-600 text-blue-600 font-semibold': activeTab === 'STANDARD',
        'text-gray-500 hover:text-gray-700': activeTab !== 'STANDARD'
      }"
      class="px-6 py-2 text-sm transition-colors"
    >
      Commandes Standard
    </button>

    <button
      *ngIf="hasAdminRole()"
      (click)="switchTab('PARTICULIERE')"
      [ngClass]="{
        'border-b-2 border-orange-500 text-orange-600 font-semibold': activeTab === 'PARTICULIERE',
        'text-gray-500 hover:text-gray-700': activeTab !== 'PARTICULIERE'
      }"
      class="px-6 py-2 text-sm transition-colors"
    >
      Commandes Particulières
    </button>
  </div>

  <!-- Filtres -->
  <div class="mb-4 flex flex-col sm:flex-row gap-3">
    <input
      type="text"
      [(ngModel)]="searchQuery"
      placeholder="Rechercher..."
      class="flex-1 rounded-md border border-2 border-gray-300  focus:outline-none focus:ring-2 focus:ring-red-500 shadow-md p-3"
    />
  </div>

  <!-- Loader -->
  <div *ngIf="isLoading" class="flex justify-center py-12">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
  </div>

  <!-- Erreur -->
  <div *ngIf="error" class="rounded-md bg-red-50 p-4 mb-6">
    <div class="flex">
      <div class="ml-3">
        <h3 class="text-sm font-medium text-red-800">{{ error }}</h3>
      </div>
    </div>
  </div>

  <!-- Tableau commun -->
  <div *ngIf="!isLoading">
    <ng-container *ngIf="activeTab === 'STANDARD'">
      <ng-container *ngTemplateOutlet="tableTemplate; context: { list: filterOrders(standardOrders) }"></ng-container>
    </ng-container>

    <ng-container *ngIf="activeTab === 'PARTICULIERE' && hasAdminRole()">
      <ng-container *ngTemplateOutlet="tableTemplate; context: { list: filterOrders(particuliereOrders) }"></ng-container>
    </ng-container>
  </div>

  <!-- Template réutilisable -->
  <ng-template #tableTemplate let-list="list">
    <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 rounded-lg">
      <table class="min-w-full divide-y divide-gray-300">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Référence</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Responsable</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Articles</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
            <th class="relative py-3 pl-3 pr-6"><span class="sr-only">Actions</span></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white">
          <tr *ngFor="let order of list" class="hover:bg-gray-50">
            <td class="whitespace-nowrap px-6 py-4 font-medium text-gray-900">
              {{ order.reference }}
            </td>
            <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
              {{ order.createdAt | date:'dd/MM/yy HH:mm' }}
            </td>
            <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
              <div>{{ order.manager.name }}</div>
              <div class="text-gray-400">{{ order.manager.email }}</div>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500">
              <div *ngFor="let piece of order.pieces" class="mb-1 last:mb-0">
                {{ piece.quantite }} × {{ piece.product?.codeArt || piece.customProduct?.codeArt || 'Produit particulier' }}
              </div>
            </td>
            <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-gray-900">
              {{ order.totalAmount | currency:'MGA':'symbol':'1.0-0' }}
            </td>
            <td class="whitespace-nowrap px-6 py-4">
              <span
                class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full {{ getStatusClass(order.status) }}">
                {{ order.status }}
              </span>
            </td>
            <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-medium space-x-2">
              <button *ngIf="order.status === 'EN_ATTENTE'" (click)="createFacture(order.id)" class="btn-primary"
                [disabled]="order.status !== 'EN_ATTENTE'">
                Créer Facture
              </button>
              <button *ngIf="order.status === 'EN_ATTENTE'" (click)="handleCancel(order.id)"
                class="text-red-600 hover:text-red-900">
                Annuler
              </button>
            </td>
          </tr>
          <tr *ngIf="!list.length">
            <td colspan="7" class="text-center text-gray-400 py-3">Aucune commande trouvée</td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-template>
</div>
